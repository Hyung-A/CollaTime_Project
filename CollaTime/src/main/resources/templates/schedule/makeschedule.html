<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/project/reset.css">
    <link rel="stylesheet" href="/css/schedule/makeschedule.css">
    <link rel="stylesheet" href="/css/schedule/createsuccess.css">
    <title>Title</title>
</head>
<body>
`
<div id="makeScheduleModal" style="z-index: 3">
    <div id="middleBlueHeader">
        <div id="makeScheduleXButton">X</div>
    </div>

    <!-- 내용, 일정 저장 폼  -->
    <form id="scheduleForm">

        <!-- 일정 제목 -->
        <div id="scheduleTitle">
            <input type="text" id="scheduleInputTitle" placeholder="일정 제목" name="scheduleName" required>
        </div>

        <!-- 색상 선택 옵션 -->
        <div id="colorOptions">
            <div class="color-button" id="color-button">
                <div class="dropdown-icon">▼</div>
            </div>
            <div class="color-dropdown" id="color-dropdown">
                <div class="color-option" data-color="CO1" style="background-color: #ff0000;"></div>
                <div class="color-option" data-color="CO2" style="background-color: #ff8c00;"></div>
                <div class="color-option" data-color="CO3" style="background-color: #ffff00;"></div>
                <div class="color-option" data-color="C04" style="background-color: #008000;"></div>
                <div class="color-option" data-color="CO5" style="background-color: #0000ff;"></div>
                <div class="color-option" data-color="CO6" style="background-color: #4b0082;"></div>
                <div class="color-option" data-color="CO7" style="background-color: #800080;"></div>
            </div>
            <input type="hidden" name="colorCode" id="selectedColor"> <!-- 선택된 색상 값 저장 -->
        </div>

        <!-- 스케줄 기간-->
        <div id="schedulePeriod">
            <img src="/css/schedule/image/시계.png" id="watch">
            <input type="date" id="scheduleStartDate" min="2024-01-01" max="2099-12-31" name="scheduleStart" required></input>
            <div id="slash">-</div>
            <input type="date" id="scheduleEndDate" min="2024-01-01" max="2099-12-31" name="scheduleEnd" required></input>
        </div>

        <!-- 참여자 -->
        <div id="participant-container">
            <div id="invite-icon">
                <img src="/css/schedule/image/인원.png" id="people">
            </div>
            <div id="participant-list">
                <span id="placeholder-text">참여자(닉네임)</span>
            </div>
        </div>

        <!-- 메모 -->
        <span><img src="/css/schedule/image/과제내용.png" id="memoIcon"></span>
        <textarea id="memo" class="memo-input" placeholder="여기에 메모를 입력하세요..." name="scheduleContent"></textarea>


        <button type="button" id="makeSchedule-CancelButton">취소</button>
        <div id="creator-info">
            생성자 | <span th:text="${creatorName}"></span>
        </div>
        <button type="button" id="makeschedule-confirmButton" onclick="submitSchedule()">확인</button>
    </form>
</div>


<script>
    const colorButton = document.getElementById('color-button');
    const colorDropdown = document.getElementById('color-dropdown');
    const colorOptions = document.querySelectorAll('.color-option');


    document.getElementById("makeScheduleXButton").addEventListener("click", function() {
        document.getElementById("makeScheduleModal").style.display = "none";
    });

    // 버튼을 클릭하면 색상 선택 드롭다운이 표시됨
    colorButton.addEventListener('click', () => {
        colorDropdown.style.display = colorDropdown.style.display === 'none' ? 'block' : 'none';
    });

    // 색상 옵션을 클릭하면 버튼 색상이 변경되고 드롭다운이 닫힘
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            const selectedColor = option.getAttribute('data-color');
            colorButton.style.backgroundColor = selectedColor;
            colorDropdown.style.display = 'none';
            colorCodeInput.value = selectedColor; // hidden input의 값 업데이트
        });
    });

    var now_date = Date.now();
    var timeOff = new Date().getTimezoneOffset()*60000;
    var today = new Date(now_date-timeOff).toISOString().split("T")[0];
    let startDate = document.getElementById("scheduleStartDate");
    startDate.setAttribute("min", today);
    startDate.onchange = function(){
        let endDate = document.getElementById("scheduleEndDate");
        endDate.setAttribute("min", this.value);
    }

    // 드롭다운 외부 클릭 시 닫힘
    document.addEventListener('click', (event) => {
        if (!colorButton.contains(event.target) && !colorDropdown.contains(event.target)) {
            colorDropdown.style.display = 'none';
        }
    });

    const inviteIcon = document.getElementById('invite-icon');
    const participantList = document.getElementById('participant-list');
    const placeholderText = document.getElementById('placeholder-text');

    inviteIcon.addEventListener('click', () => {
        // 팀원을 초대하는 모달을 여는 코드 (여기서는 임시로 구현)
        const newParticipant = document.createElement('span');
        newParticipant.textContent = "팀원 1"; // 실제로는 초대한 팀원의 이름으로 변경
        participantList.appendChild(newParticipant);

        // 기존의 "참여자(닉네임)" 텍스트를 제거
        if (placeholderText) {
            placeholderText.remove();
        }
    });

    // JavaScript로 폼 데이터 전송
    function submitSchedule() {

        const colorCodeInput = document.getElementById("selectedColor");
        colorCodeInput.value = "CO1"; // 기본값 설정

        const scheduleData = {
            projectNo: 1,
            scheduleTitle: document.getElementById("scheduleInputTitle").value,
            colorCode: document.getElementById("selectedColor").value,
            scheduleStartDate: document.getElementById("scheduleStartDate").value,
            scheduleEndDate: document.getElementById("scheduleEndDate").value,
            scheduleContent: document.getElementById("memo").value,
            scheduleCreator: document.getElementById("creator-info").textContent.trim().split('|')[1].trim()
        };

        fetch('/api/schedules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(scheduleData)
        })
            .then(response => {
                if (response.ok) {
                    // alert("일정이 저장되었습니다!");
                    // window.location.reload();  // 새로고침하여 업데이트 반영
                    document.dispatchEvent(new CustomEvent("scheduleCreated")); // 이벤트 전송
                } else {
                    alert("저장에 실패했습니다. 다시 시도해주세요.");
                }
            })
            .catch(error => console.error("Error:", error));
    }
</script>
</body>
</html>
